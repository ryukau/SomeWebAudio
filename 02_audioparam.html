<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8>
  <title>WebAudioSnippets</title>

  <!-- highlight.js -->
  <link rel="stylesheet" href="highlight/styles/idea.css">
  <script src="highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <style>
    body {
      max-width: 704px;
      margin: auto;
      padding: 32px 8px;
    }

    kbd {
      border-style: solid;
      border-width: 1px 2px 2px 1px;
      border-radius: 2px;
      padding: 2px;
      margin: 2px;
    }

    code.sourceCode {
      border: 1px solid black;
    }

    footer {
      border-top: 1px gray solid;
      padding: 0.5em;
      margin-top: 1em;
    }

    input[type="button"] {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      font-size: 16px;
      height: 32px;
    }

    input[type="button"]:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    div.numberInput {
      display: block;
      white-space: nowrap;
    }

    div.numberInput:hover {
      background-color: #e0ecff;
    }

    .numberInputLabel {
      /* max 12 letter  */
      display: inline-block;
      margin: 0 8px 0 8px;
      text-align: left;
      width: 80px;

      font-size: 10pt;
      font-family: 'Courier New', Courier, monospace;
    }

    .numberInputNumber {
      display: inline-block;
      width: 60px;
    }

    .numberInputRange {
      display: inline-block;
      width: 140px;
    }

    .pullDownMenu {
      display: inline-block;
      text-align: left;
      width: 100%;
    }

    .pullDownMenu:hover {
      background-color: #e0ecff;
    }

    select {
      background-color: #ffffff;
      border: 2px solid #aaaaaa;
      height: 20px;
      margin-top: 2px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    select:hover {
      background-color: #ffffff;
      border: 2px solid #aaccff;
    }

    .divControl {
      display: inline-block;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <h1 id="audioparamでオートメーション">AudioParamでオートメーション</h1>
<p><a href="https://webaudio.github.io/web-audio-api/#AudioParam"><code>AudioParam</code></a> として定義されているノードのパラメータは、次の関数を組み合わせてオートメーションができます。</p>
<ul>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-setvalueattime"><code>setValueAtTime</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-linearramptovalueattime"><code>linearRampToValueAtTime</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-exponentialramptovalueattime"><code>exponentialRampToValueAtTime</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-settargetattime"><code>setTargetAtTime</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-setvaluecurveattime"><code>setValueCurveAtTime</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-cancelscheduledvalues"><code>cancelScheduledValues</code></a></li>
<li><a href="https://webaudio.github.io/web-audio-api/#dom-audioparam-cancelandholdattime"><code>cancelAndHoldAtTime</code></a></li>
</ul>
<p>オートメーションの開始・終了時刻を指定するときは <a href="https://webaudio.github.io/web-audio-api/#dom-baseaudiocontext-currenttime"><code>AudioContext.currentTime</code></a> を使います。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">var</span> ctx <span class="op">=</span> <span class="kw">new</span> <span class="at">AudioContext</span>()</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="va">ctx</span>.<span class="at">currentTime</span> <span class="co">// AudioContext のインスタンスが生成されてからの経過時間 [秒] 。</span></a></code></pre></div>
<p>ここではオートメーションを使ってエンベロープを作り、簡単なシーケンスを演奏します。</p>
<h2 id="シンセサイザのエンベロープ">シンセサイザのエンベロープ</h2>
<p>シンセサイザで使われるエンベロープは、トリガされると low から high に向かって増加したあと high から low に向かって減少するような信号を出力します。エンベロープの出力をオシレータの出力やサンプルデータと掛け合わせることで音量の変化を作ることができます。</p>
<p>よくあるシンセサイザのエンベロープはAttack、Decay、Sustain、Releaseの4つの区間が組み合わさっています。4つの区間をそれぞれ1文字に略してADSRと言うことがあります。次の図はADSRエンベロープを表しています。</p>
<figure>
<img src="02_adsr_envelope.svg" alt="Image of ADOsc audio graph." style="width: 480px; padding-bottom: 12px;"/>
</figure>
<p>Attack は low から high までの立ち上がりにかかる時間、 Decay は high から Sustain の値までの減衰にかかる時間です。</p>
<p>Sustainは、Decayの終わりから指が鍵盤が離される(<a href="https://www.g200kg.com/jp/docs/dic/noteoff.html">ノートオフ</a>)までの区間ですが、ユーザが操作するパラメータとしてはその区間でエンベロープが出力する値の大きさになっています。</p>
<p>Releaseはノートオフの後、エンベロープが low まで減衰するのにかかる時間です。AttackやDecayの途中でノートオフされたときもReleaseに移行します。</p>
<h3 id="実装">実装</h3>
<p>次の図のようなルーティングのシンセサイザを実装します。</p>
<figure>
<img src="02_synth.svg" alt="Image of ADOsc audio graph." style="width: 420px; padding-bottom: 12px;"/>
</figure>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">function</span> <span class="at">createOscillator</span>(audioContext<span class="op">,</span> parentNode<span class="op">,</span> type<span class="op">,</span> frequency<span class="op">,</span> detune) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">var</span> osc <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">createOscillator</span>()</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="va">osc</span>.<span class="at">type</span> <span class="op">=</span> type</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="va">osc</span>.<span class="va">frequency</span>.<span class="at">value</span> <span class="op">=</span> frequency</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="va">osc</span>.<span class="va">detune</span>.<span class="at">value</span> <span class="op">=</span> detune</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="va">osc</span>.<span class="at">connect</span>(parentNode)</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="cf">return</span> osc</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">function</span> <span class="at">createGain</span>(audioContext<span class="op">,</span> parentNode<span class="op">,</span> gain) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="kw">var</span> gainNode <span class="op">=</span> <span class="va">audioContext</span>.<span class="at">createGain</span>()</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  <span class="va">gainNode</span>.<span class="va">gain</span>.<span class="at">value</span> <span class="op">=</span> gain</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  <span class="va">gainNode</span>.<span class="at">connect</span>(parentNode)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  <span class="cf">return</span> gainNode</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">class</span> Synth <span class="op">{</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  <span class="at">constructor</span>(</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    ctx<span class="op">,</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">    parent<span class="op">,</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">    gainPeak <span class="op">=</span> <span class="fl">0.1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">    gainAttack <span class="op">=</span> <span class="fl">0.02</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">    gainDecay <span class="op">=</span> <span class="fl">0.4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">    gainSustain <span class="op">=</span> <span class="fl">0.01</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">    gainRelease <span class="op">=</span> <span class="fl">0.8</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    numOsc <span class="op">=</span> <span class="dv">4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    detuneDelta <span class="op">=</span> <span class="dv">200</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">    type <span class="op">=</span> <span class="st">&quot;sine&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    frequency <span class="op">=</span> <span class="dv">440</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">    detune <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">    <span class="kw">this</span>.<span class="at">ctx</span> <span class="op">=</span> ctx</a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34">    <span class="kw">this</span>.<span class="at">gainNode</span> <span class="op">=</span> <span class="at">createGain</span>(ctx<span class="op">,</span> parent<span class="op">,</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">    <span class="kw">this</span>.<span class="at">osc</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">Array</span>(numOsc)</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="kw">this</span>.<span class="va">osc</span>.<span class="at">length</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38">      <span class="kw">this</span>.<span class="at">osc</span>[i] <span class="op">=</span> <span class="at">createOscillator</span>(</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">        ctx<span class="op">,</span> <span class="kw">this</span>.<span class="at">gainNode</span><span class="op">,</span> type<span class="op">,</span> frequency<span class="op">,</span> detune <span class="op">+</span> detuneDelta <span class="op">*</span> i)</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">      <span class="kw">this</span>.<span class="at">osc</span>[i].<span class="at">start</span>()</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"></a>
<a class="sourceLine" id="cb2-43" data-line-number="43">    <span class="kw">this</span>.<span class="at">gainPeak</span> <span class="op">=</span> gainPeak / numOsc</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">    <span class="kw">this</span>.<span class="at">gainAttack</span> <span class="op">=</span> gainAttack</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">    <span class="kw">this</span>.<span class="at">gainDecay</span> <span class="op">=</span> gainDecay</a>
<a class="sourceLine" id="cb2-46" data-line-number="46">    <span class="kw">this</span>.<span class="at">gainSustain</span> <span class="op">=</span> gainSustain</a>
<a class="sourceLine" id="cb2-47" data-line-number="47">    <span class="kw">this</span>.<span class="at">gainRelease</span> <span class="op">=</span> gainRelease</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49"></a>
<a class="sourceLine" id="cb2-50" data-line-number="50">  <span class="at">scheduleLinADS</span>(audioParam<span class="op">,</span> peak<span class="op">,</span> attack<span class="op">,</span> decay<span class="op">,</span> sustain) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-51" data-line-number="51">    <span class="kw">var</span> currentTime <span class="op">=</span> <span class="kw">this</span>.<span class="va">ctx</span>.<span class="at">currentTime</span></a>
<a class="sourceLine" id="cb2-52" data-line-number="52">    <span class="va">audioParam</span>.<span class="at">cancelScheduledValues</span>(currentTime)</a>
<a class="sourceLine" id="cb2-53" data-line-number="53">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.002</span> <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(peak<span class="op">,</span> attack <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb2-55" data-line-number="55">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(sustain<span class="op">,</span> attack <span class="op">+</span> decay <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-57" data-line-number="57"></a>
<a class="sourceLine" id="cb2-58" data-line-number="58">  <span class="at">scheduleLinRelease</span>(audioParam<span class="op">,</span> release) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-59" data-line-number="59">    <span class="kw">var</span> currentTime <span class="op">=</span> <span class="kw">this</span>.<span class="va">ctx</span>.<span class="at">currentTime</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> release <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb2-61" data-line-number="61">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-62" data-line-number="62"></a>
<a class="sourceLine" id="cb2-63" data-line-number="63">  <span class="at">trigger</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-64" data-line-number="64">    <span class="kw">this</span>.<span class="at">scheduleLinADS</span>(<span class="kw">this</span>.<span class="va">gainNode</span>.<span class="at">gain</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">gainPeak</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-65" data-line-number="65">      <span class="kw">this</span>.<span class="at">gainAttack</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">gainDecay</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">gainSustain</span>)</a>
<a class="sourceLine" id="cb2-66" data-line-number="66">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-67" data-line-number="67"></a>
<a class="sourceLine" id="cb2-68" data-line-number="68">  <span class="at">release</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-69" data-line-number="69">    <span class="kw">this</span>.<span class="at">scheduleLinRelease</span>(<span class="kw">this</span>.<span class="va">gainNode</span>.<span class="at">gain</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">gainRelease</span>)</a>
<a class="sourceLine" id="cb2-70" data-line-number="70">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-71" data-line-number="71"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-72" data-line-number="72"></a>
<a class="sourceLine" id="cb2-73" data-line-number="73"><span class="kw">var</span> ctx <span class="op">=</span> <span class="kw">new</span> <span class="at">AudioContext</span>()</a>
<a class="sourceLine" id="cb2-74" data-line-number="74"><span class="kw">var</span> synth <span class="op">=</span> <span class="kw">new</span> <span class="at">Synth</span>(ctx<span class="op">,</span> <span class="va">ctx</span>.<span class="at">destination</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-75" data-line-number="75">  <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.3</span><span class="op">,</span> <span class="fl">0.6</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="fl">1.2</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="fl">500.01</span><span class="op">,</span> <span class="st">&quot;square&quot;</span><span class="op">,</span> <span class="dv">440</span><span class="op">,</span> <span class="dv">0</span>)</a></code></pre></div>
<p>次のボタンを押すと <code>Synth.trigger</code> 、離すと <code>Synth.release</code> を呼び出します。</p>
<div id="divSynthTrigger">

</div>
<p><code>scheduleLinADS</code> の次の行は、リリースの途中で再度トリガされたときにエンベロープが 0 にリセットされるようにしています。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" data-line-number="1">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.002</span> <span class="op">+</span> currentTime)</a></code></pre></div>
<p>次の図はリセットありとリセットなしを比べています。エンベロープの緑で強調した部分が違いです。AとBの時間の長さは同じです。</p>
<figure>
<img src="02_adsr_envelope_reset.svg" alt="Image of ADOsc audio graph." style="width: 700px; padding-bottom: 12px;"/>
</figure>
<p>0.002 という値は適当に決めた値です。この値が小さすぎるとエンベロープがリセットされたときにプチノイズが聞こえることがあります。</p>
<p><code>linearRampToValueAtTime</code> を <code>exponentialRampToValueAtTime</code> に変えてみます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">// Synth のメソッド</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="at">scheduleExpADS</span>(audioParam<span class="op">,</span> peak<span class="op">,</span> attack<span class="op">,</span> decay<span class="op">,</span> sustain) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="kw">var</span> currentTime <span class="op">=</span> <span class="kw">this</span>.<span class="va">ctx</span>.<span class="at">currentTime</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="va">audioParam</span>.<span class="at">cancelScheduledValues</span>(currentTime)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> <span class="fl">0.002</span> <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(peak<span class="op">,</span> attack <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(sustain<span class="op">,</span> attack <span class="op">+</span> decay <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  <span class="at">scheduleExpRelease</span>(audioParam<span class="op">,</span> release) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">    <span class="kw">var</span> currentTime <span class="op">=</span> <span class="kw">this</span>.<span class="va">ctx</span>.<span class="at">currentTime</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> release <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> release <span class="op">+</span> <span class="fl">0.001</span> <span class="op">+</span> currentTime)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">  <span class="op">}</span></a></code></pre></div>
<p><code>exponentialRampToValueAtTime</code> は一つ目の引数 <code>value</code> に 0 が指定できないので、代わりに 1e-4 という適当に決めた値を使っています。リリースの終了後に 0 にリセットするため <code>linearRampToValueAtTime</code> を一つ加えています。</p>
<p>次のボタンで <code>exponentialRampToValueAtTime</code> を使ったエンベロープを試聴できます。</p>
<div id="divSynthTriggerExpADSR">

</div>
<h2 id="シーケンスの演奏">シーケンスの演奏</h2>
<p>とりあえず <code>Synth</code> を拡張してシーケンスを演奏させてみます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">class</span> Synth <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="co">// 途中を省略</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="at">scheduleNoteEnv</span>(</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    duration<span class="op">,</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    audioParam<span class="op">,</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    peak<span class="op">,</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">    attack<span class="op">,</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    decay<span class="op">,</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    sustain<span class="op">,</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    release</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    <span class="va">audioParam</span>.<span class="at">setValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> startTime)</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> <span class="fl">0.002</span> <span class="op">+</span> startTime)</a>
<a class="sourceLine" id="cb5-17" data-line-number="17"></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    <span class="kw">var</span> attackTime <span class="op">=</span> attack <span class="op">+</span> startTime</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(peak<span class="op">,</span> attackTime)</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(sustain<span class="op">,</span> decay <span class="op">+</span> attackTime)</a>
<a class="sourceLine" id="cb5-21" data-line-number="21"></a>
<a class="sourceLine" id="cb5-22" data-line-number="22">    <span class="kw">var</span> releaseTime <span class="op">=</span> duration <span class="op">+</span> release <span class="op">+</span> startTime</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> releaseTime)</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.001</span> <span class="op">+</span> releaseTime)</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"></a>
<a class="sourceLine" id="cb5-27" data-line-number="27">  <span class="at">scheduleNote</span>(startTime<span class="op">,</span> duration<span class="op">,</span> frequency) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28">    <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="kw">this</span>.<span class="va">osc</span>.<span class="at">length</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29">      <span class="kw">this</span>.<span class="at">osc</span>[i].<span class="va">frequency</span>.<span class="at">setValueAtTime</span>(frequency<span class="op">,</span> startTime)</a>
<a class="sourceLine" id="cb5-30" data-line-number="30">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31"></a>
<a class="sourceLine" id="cb5-32" data-line-number="32">    <span class="kw">this</span>.<span class="at">scheduleNoteEnv</span>(</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">      startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb5-34" data-line-number="34">      duration<span class="op">,</span></a>
<a class="sourceLine" id="cb5-35" data-line-number="35">      <span class="kw">this</span>.<span class="va">gainNode</span>.<span class="at">gain</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36">      <span class="kw">this</span>.<span class="at">gainPeak</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37">      <span class="kw">this</span>.<span class="at">gainAttack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38">      <span class="kw">this</span>.<span class="at">gainDecay</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-39" data-line-number="39">      <span class="kw">this</span>.<span class="at">gainSustain</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-40" data-line-number="40">      <span class="kw">this</span>.<span class="at">gainRelease</span></a>
<a class="sourceLine" id="cb5-41" data-line-number="41">    )</a>
<a class="sourceLine" id="cb5-42" data-line-number="42">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-43" data-line-number="43"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-44" data-line-number="44"></a>
<a class="sourceLine" id="cb5-45" data-line-number="45"><span class="kw">var</span> synths <span class="op">=</span> []</a>
<a class="sourceLine" id="cb5-46" data-line-number="46"><span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">8</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-47" data-line-number="47">  <span class="va">synths</span>.<span class="at">push</span>(<span class="kw">new</span> <span class="at">Synth</span>(ctx<span class="op">,</span> <span class="va">ctx</span>.<span class="at">destination</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-48" data-line-number="48">    <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.03</span><span class="op">,</span> <span class="fl">0.2</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="fl">1.2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">200</span> <span class="op">+</span> <span class="dv">200</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">random</span>()<span class="op">,</span> <span class="st">&quot;square&quot;</span><span class="op">,</span> <span class="dv">440</span><span class="op">,</span> <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb5-49" data-line-number="49"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-50" data-line-number="50"></a>
<a class="sourceLine" id="cb5-51" data-line-number="51"><span class="kw">var</span> seq <span class="op">=</span> []</a>
<a class="sourceLine" id="cb5-52" data-line-number="52"><span class="kw">var</span> startTime <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-53" data-line-number="53"></a>
<a class="sourceLine" id="cb5-54" data-line-number="54"><span class="co">// 適当なシーケンスを作成。</span></a>
<a class="sourceLine" id="cb5-55" data-line-number="55"><span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-56" data-line-number="56">  <span class="va">seq</span>.<span class="at">push</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb5-57" data-line-number="57">    <span class="dt">frequency</span><span class="op">:</span> (<span class="va">Math</span>.<span class="at">floor</span>(<span class="va">Math</span>.<span class="at">random</span>() <span class="op">*</span> <span class="dv">23</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">60</span>)</a>
<a class="sourceLine" id="cb5-58" data-line-number="58">      <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.01</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">random</span>())<span class="op">,</span></a>
<a class="sourceLine" id="cb5-59" data-line-number="59">    <span class="dt">duration</span><span class="op">:</span> <span class="va">Math</span>.<span class="at">random</span>() <span class="op">+</span> <span class="fl">0.01</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-60" data-line-number="60">    <span class="dt">startTime</span><span class="op">:</span> startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb5-61" data-line-number="61">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb5-62" data-line-number="62">  startTime <span class="op">+=</span> <span class="fl">0.1</span> <span class="op">+</span> <span class="va">Math</span>.<span class="at">random</span>() <span class="op">*</span> <span class="fl">0.3</span></a>
<a class="sourceLine" id="cb5-63" data-line-number="63"><span class="op">}</span></a>
<a class="sourceLine" id="cb5-64" data-line-number="64"></a>
<a class="sourceLine" id="cb5-65" data-line-number="65"><span class="kw">var</span> divSequence <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;divSequence&quot;</span>)</a>
<a class="sourceLine" id="cb5-66" data-line-number="66"></a>
<a class="sourceLine" id="cb5-67" data-line-number="67"><span class="co">// Button は &lt;input type=&quot;button&quot;&gt; を簡単に作るためのクラス。</span></a>
<a class="sourceLine" id="cb5-68" data-line-number="68"><span class="co">// 三つ目の引数は click イベントに応じて呼び出される。</span></a>
<a class="sourceLine" id="cb5-69" data-line-number="69"><span class="kw">var</span> buttonSeq <span class="op">=</span> <span class="kw">new</span> <span class="at">Button</span>(divSequence<span class="op">,</span> <span class="st">&quot;Start Sequence&quot;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-70" data-line-number="70">  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">seq</span>.<span class="at">length</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-71" data-line-number="71">    synths[i <span class="op">%</span> <span class="va">synths</span>.<span class="at">length</span>].<span class="at">scheduleNote</span>(</a>
<a class="sourceLine" id="cb5-72" data-line-number="72">      <span class="va">ctx</span>.<span class="at">currentTime</span> <span class="op">+</span> seq[i].<span class="at">startTime</span><span class="op">,</span> seq[i].<span class="at">duration</span><span class="op">,</span> seq[i].<span class="at">frequency</span>)</a>
<a class="sourceLine" id="cb5-73" data-line-number="73">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-74" data-line-number="74"><span class="op">}</span>)</a></code></pre></div>
<p>次のボタンで演奏を開始します。</p>
<div id="divSequence1">

</div>
<p>複数のノートが同時に演奏される場合のために、複数の <code>Synth</code> を作っています。 <code>i</code> 番目のノートを <code>synths[i % synth.length]</code> にスケジュールしています。上のボタンで演奏するとところどころ正しく再生されていない部分があるように聞こえます。</p>
<p>ノートごとに新しいノードを作る方法で演奏してみます。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">class</span> Synth2 <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="at">constructor</span>(</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    ctx<span class="op">,</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    parent<span class="op">,</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    gainPeak <span class="op">=</span> <span class="fl">0.1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    gainAttack <span class="op">=</span> <span class="fl">0.02</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    gainDecay <span class="op">=</span> <span class="fl">0.4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    gainSustain <span class="op">=</span> <span class="fl">0.01</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    gainRelease <span class="op">=</span> <span class="fl">0.8</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    type <span class="op">=</span> <span class="st">&quot;sine&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    detune <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="kw">this</span>.<span class="at">ctx</span> <span class="op">=</span> ctx</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="kw">this</span>.<span class="at">parent</span> <span class="op">=</span> parent</a>
<a class="sourceLine" id="cb6-16" data-line-number="16"></a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="kw">this</span>.<span class="at">type</span> <span class="op">=</span> type</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    <span class="kw">this</span>.<span class="at">detune</span> <span class="op">=</span> detune</a>
<a class="sourceLine" id="cb6-19" data-line-number="19"></a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    <span class="kw">this</span>.<span class="at">gainPeak</span> <span class="op">=</span> gainPeak</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    <span class="kw">this</span>.<span class="at">gainAttack</span> <span class="op">=</span> gainAttack</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">    <span class="kw">this</span>.<span class="at">gainDecay</span> <span class="op">=</span> gainDecay</a>
<a class="sourceLine" id="cb6-23" data-line-number="23">    <span class="kw">this</span>.<span class="at">gainSustain</span> <span class="op">=</span> gainSustain</a>
<a class="sourceLine" id="cb6-24" data-line-number="24">    <span class="kw">this</span>.<span class="at">gainRelease</span> <span class="op">=</span> gainRelease</a>
<a class="sourceLine" id="cb6-25" data-line-number="25"></a>
<a class="sourceLine" id="cb6-26" data-line-number="26">    <span class="kw">this</span>.<span class="at">usedNode</span> <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"></a>
<a class="sourceLine" id="cb6-29" data-line-number="29">  <span class="at">createNode</span>(frequency) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30">    <span class="kw">var</span> gain <span class="op">=</span> <span class="at">createGain</span>(<span class="kw">this</span>.<span class="at">ctx</span><span class="op">,</span> <span class="kw">this</span>.<span class="at">parent</span><span class="op">,</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">    <span class="kw">var</span> osc <span class="op">=</span> <span class="at">createOscillator</span>(</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">      <span class="kw">this</span>.<span class="at">ctx</span><span class="op">,</span> gain<span class="op">,</span> <span class="kw">this</span>.<span class="at">type</span><span class="op">,</span> frequency<span class="op">,</span> <span class="kw">this</span>.<span class="at">detune</span>)</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">    <span class="cf">return</span> <span class="op">{</span> <span class="dt">gain</span><span class="op">:</span> gain<span class="op">,</span> <span class="dt">osc</span><span class="op">:</span> osc <span class="op">}</span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"></a>
<a class="sourceLine" id="cb6-36" data-line-number="36">  <span class="at">scheduleNoteEnv</span>(</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    duration<span class="op">,</span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39">    audioParam<span class="op">,</span></a>
<a class="sourceLine" id="cb6-40" data-line-number="40">    peak<span class="op">,</span></a>
<a class="sourceLine" id="cb6-41" data-line-number="41">    attack<span class="op">,</span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42">    decay<span class="op">,</span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">    sustain<span class="op">,</span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44">    release</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">  ) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-46" data-line-number="46">    <span class="va">audioParam</span>.<span class="at">setValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> startTime)</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> <span class="fl">0.002</span> <span class="op">+</span> startTime)</a>
<a class="sourceLine" id="cb6-48" data-line-number="48"></a>
<a class="sourceLine" id="cb6-49" data-line-number="49">    <span class="kw">var</span> attackTime <span class="op">=</span> attack <span class="op">+</span> startTime</a>
<a class="sourceLine" id="cb6-50" data-line-number="50">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(peak<span class="op">,</span> attackTime)</a>
<a class="sourceLine" id="cb6-51" data-line-number="51">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(sustain<span class="op">,</span> decay <span class="op">+</span> attackTime)</a>
<a class="sourceLine" id="cb6-52" data-line-number="52"></a>
<a class="sourceLine" id="cb6-53" data-line-number="53">    <span class="kw">var</span> releaseTime <span class="op">=</span> duration <span class="op">+</span> release <span class="op">+</span> startTime</a>
<a class="sourceLine" id="cb6-54" data-line-number="54">    <span class="va">audioParam</span>.<span class="at">exponentialRampToValueAtTime</span>(<span class="fl">1e-4</span><span class="op">,</span> releaseTime)</a>
<a class="sourceLine" id="cb6-55" data-line-number="55">    <span class="va">audioParam</span>.<span class="at">linearRampToValueAtTime</span>(<span class="dv">0</span><span class="op">,</span> <span class="fl">0.001</span> <span class="op">+</span> releaseTime)</a>
<a class="sourceLine" id="cb6-56" data-line-number="56">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-57" data-line-number="57"></a>
<a class="sourceLine" id="cb6-58" data-line-number="58">  <span class="at">scheduleNote</span>(startTime<span class="op">,</span> duration<span class="op">,</span> frequency) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-59" data-line-number="59">    <span class="kw">var</span> node <span class="op">=</span> <span class="kw">this</span>.<span class="at">createNode</span>(frequency)</a>
<a class="sourceLine" id="cb6-60" data-line-number="60"></a>
<a class="sourceLine" id="cb6-61" data-line-number="61">    <span class="va">node</span>.<span class="va">osc</span>.<span class="at">start</span>(startTime)</a>
<a class="sourceLine" id="cb6-62" data-line-number="62"></a>
<a class="sourceLine" id="cb6-63" data-line-number="63">    <span class="kw">this</span>.<span class="at">scheduleNoteEnv</span>(</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">      startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">      duration<span class="op">,</span></a>
<a class="sourceLine" id="cb6-66" data-line-number="66">      <span class="va">node</span>.<span class="va">gain</span>.<span class="at">gain</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-67" data-line-number="67">      <span class="kw">this</span>.<span class="at">gainPeak</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-68" data-line-number="68">      <span class="kw">this</span>.<span class="at">gainAttack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-69" data-line-number="69">      <span class="kw">this</span>.<span class="at">gainDecay</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-70" data-line-number="70">      <span class="kw">this</span>.<span class="at">gainSustain</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-71" data-line-number="71">      <span class="kw">this</span>.<span class="at">gainRelease</span></a>
<a class="sourceLine" id="cb6-72" data-line-number="72">    )</a>
<a class="sourceLine" id="cb6-73" data-line-number="73"></a>
<a class="sourceLine" id="cb6-74" data-line-number="74">    <span class="kw">this</span>.<span class="va">usedNode</span>.<span class="at">push</span>(node)</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-76" data-line-number="76"></a>
<a class="sourceLine" id="cb6-77" data-line-number="77">  <span class="at">midiNoteNumberToFrequency</span>(number) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-78" data-line-number="78">    <span class="cf">return</span> <span class="dv">440</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">pow</span>(<span class="dv">2</span><span class="op">,</span> (number <span class="op">-</span> <span class="dv">69</span>) / <span class="dv">12</span>)</a>
<a class="sourceLine" id="cb6-79" data-line-number="79">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-80" data-line-number="80"></a>
<a class="sourceLine" id="cb6-81" data-line-number="81">  <span class="at">cleanup</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb6-82" data-line-number="82">    <span class="cf">for</span> (<span class="kw">var</span> node of <span class="kw">this</span>.<span class="at">usedNode</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-83" data-line-number="83">      <span class="va">node</span>.<span class="va">gain</span>.<span class="at">disconnect</span>()</a>
<a class="sourceLine" id="cb6-84" data-line-number="84">      <span class="va">node</span>.<span class="va">osc</span>.<span class="at">stop</span>()</a>
<a class="sourceLine" id="cb6-85" data-line-number="85">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-86" data-line-number="86">    <span class="kw">this</span>.<span class="at">usedNode</span> <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-87" data-line-number="87">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-88" data-line-number="88"></a>
<a class="sourceLine" id="cb6-89" data-line-number="89">  <span class="co">// sequence = [{startTime, duration, number}, ...]</span></a>
<a class="sourceLine" id="cb6-90" data-line-number="90">  <span class="at">scheduleSequence</span>(sequence) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-91" data-line-number="91">    <span class="kw">this</span>.<span class="at">cleanup</span>()</a>
<a class="sourceLine" id="cb6-92" data-line-number="92"></a>
<a class="sourceLine" id="cb6-93" data-line-number="93">    <span class="kw">var</span> currentTime <span class="op">=</span> <span class="kw">this</span>.<span class="va">ctx</span>.<span class="at">currentTime</span></a>
<a class="sourceLine" id="cb6-94" data-line-number="94">    <span class="cf">for</span> (<span class="kw">var</span> note of sequence) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-95" data-line-number="95">      <span class="kw">this</span>.<span class="at">scheduleNote</span>(</a>
<a class="sourceLine" id="cb6-96" data-line-number="96">        currentTime <span class="op">+</span> <span class="va">note</span>.<span class="at">startTime</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-97" data-line-number="97">        <span class="va">note</span>.<span class="at">duration</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-98" data-line-number="98">        <span class="kw">this</span>.<span class="at">midiNoteNumberToFrequency</span>(<span class="va">note</span>.<span class="at">number</span>)</a>
<a class="sourceLine" id="cb6-99" data-line-number="99">      )</a>
<a class="sourceLine" id="cb6-100" data-line-number="100">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-101" data-line-number="101">  <span class="op">}</span></a>
<a class="sourceLine" id="cb6-102" data-line-number="102"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-103" data-line-number="103"></a>
<a class="sourceLine" id="cb6-104" data-line-number="104"><span class="kw">var</span> scale <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">14</span><span class="op">,</span> <span class="dv">17</span>]</a>
<a class="sourceLine" id="cb6-105" data-line-number="105"><span class="kw">var</span> seq2 <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-106" data-line-number="106"><span class="kw">var</span> startTime <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-107" data-line-number="107"><span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-108" data-line-number="108">  <span class="va">seq2</span>.<span class="at">push</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb6-109" data-line-number="109">    <span class="dt">startTime</span><span class="op">:</span> startTime<span class="op">,</span></a>
<a class="sourceLine" id="cb6-110" data-line-number="110">    <span class="dt">duration</span><span class="op">:</span> <span class="va">Math</span>.<span class="at">random</span>() <span class="op">+</span> <span class="fl">0.01</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-111" data-line-number="111">    <span class="dt">number</span><span class="op">:</span> <span class="dv">42</span> <span class="op">+</span> scale[<span class="va">Math</span>.<span class="at">floor</span>(<span class="va">Math</span>.<span class="at">random</span>() <span class="op">*</span> <span class="va">scale</span>.<span class="at">length</span>)]<span class="op">,</span></a>
<a class="sourceLine" id="cb6-112" data-line-number="112">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb6-113" data-line-number="113">  startTime <span class="op">+=</span> <span class="fl">0.14</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="va">Math</span>.<span class="at">floor</span>(<span class="va">Math</span>.<span class="at">random</span>() <span class="op">+</span> <span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb6-114" data-line-number="114"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-115" data-line-number="115"><span class="kw">var</span> synth2 <span class="op">=</span> <span class="kw">new</span> <span class="at">Synth2</span>(ctx<span class="op">,</span> <span class="va">ctx</span>.<span class="at">destination</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-116" data-line-number="116">  <span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.15</span><span class="op">,</span> <span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.01</span><span class="op">,</span> <span class="fl">1.8</span><span class="op">,</span> <span class="st">&quot;sine&quot;</span><span class="op">,</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb6-117" data-line-number="117"></a>
<a class="sourceLine" id="cb6-118" data-line-number="118"><span class="kw">var</span> divSequence2 <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;divSequence2&quot;</span>)</a>
<a class="sourceLine" id="cb6-119" data-line-number="119"><span class="kw">var</span> buttonSeq <span class="op">=</span> <span class="kw">new</span> <span class="at">Button</span>(divSequence2<span class="op">,</span> <span class="st">&quot;Start Sequence&quot;</span><span class="op">,</span> () <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-120" data-line-number="120">  <span class="va">synth2</span>.<span class="at">scheduleSequence</span>(seq2)</a>
<a class="sourceLine" id="cb6-121" data-line-number="121"><span class="op">}</span>)</a></code></pre></div>
<p>次のボタンで演奏を開始します。</p>
<div id="divSequence2">

</div>
<p>毎回ノードを作り直す方が滑らかに演奏されます。使い終わったノードは <a href="https://webaudio.github.io/web-audio-api/#dom-audionode-disconnect"><code>disconnect</code></a> した上で、どこからも参照されないようにすることでガベージコレクタに回収されるようです。</p>
<ul>
<li><a href="https://webaudio.github.io/web-audio-api/#lifetime-AudioNode">Web Audio API - AudioNode - Lifetime</a></li>
</ul>
<script type="module" src="02_audioparam.js"></script>


  <footer>
    <a href="index.html">トップに戻る</a>
  </footer>
</body>

</html>
